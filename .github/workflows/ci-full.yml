name: Full CI Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  security-scan:
    name: Security & Dependency Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install and audit dependencies
      working-directory: ./rdzwx-go
      run: |
        npm install
        npm audit --audit-level=high
      continue-on-error: false

    - name: Check for security patterns
      working-directory: ./rdzwx-go
      run: |
        ! grep -r "\beval\(" www/ || (echo "ERROR: eval() usage found!" && exit 1)
        echo "Security checks passed"

  android-test:
    name: Android Build Test
    needs: security-scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Cordova
      run: npm install -g cordova@latest

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Install SDK components
      run: sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0"

    - name: Build Android
      working-directory: ./rdzwx-go
      run: |
        npm install
        npm install jetifier && npx jetifier
        cordova platform add android
        cordova plugin add ../rdzwx-plugin/
        cordova build android --debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-full-ci
        path: rdzwx-go/platforms/android/app/build/outputs/apk/debug/*.apk
        retention-days: 14

  ios-test:
    name: iOS Build Test
    needs: security-scan
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Cordova
      run: npm install -g cordova@latest

    - name: Build iOS
      working-directory: ./rdzwx-go
      run: |
        npm install
        cordova platform add ios
        cordova plugin add ../rdzwx-plugin/
        cordova build ios --emulator

    - name: Upload iOS App
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-full-ci
        path: rdzwx-go/platforms/ios/build/emulator/*.app
        if-no-files-found: warn
        retention-days: 14

  summary:
    name: CI Summary
    needs: [security-scan, android-test, ios-test]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Check build status
      run: |
        echo "=== CI Pipeline Summary ==="
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo "Android Build: ${{ needs.android-test.result }}"
        echo "iOS Build: ${{ needs.ios-test.result }}"

        if [ "${{ needs.security-scan.result }}" != "success" ] || \
           [ "${{ needs.android-test.result }}" != "success" ] || \
           [ "${{ needs.ios-test.result }}" != "success" ]; then
          echo "❌ CI Pipeline Failed"
          exit 1
        else
          echo "✅ CI Pipeline Passed"
        fi
